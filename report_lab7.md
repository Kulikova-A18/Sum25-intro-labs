# **Лабораторная работа по основам GitOps**

Эта лабораторная работа изучает основные принципы GitOps, моделируя ключевые рабочие процессы, используя только инструменты командной строки Linux. Студенты будут:

1. Практиковать **декларативное управление конфигурацией**
2. Реализовать **автоматизированное согласование**
3. Создавать **самовосстанавливающиеся системы**
4. Контролировать **состояние работоспособности синхронизации**

Никаких инструментов Kubernetes или GitOps не требуется!

---

## **Задание 1: Согласование состояния Git**

**Цель**: Моделировать, как операторы GitOps непрерывно синхронизируют состояние кластера с Git

Почему это важно:

- Понять основной цикл согласования в GitOps
- Узнать, почему декларативная конфигурация > императивные команды
- Увидеть, как автоматизация предотвращает дрейф конфигурации

Используемые инструменты:

`git` | `watch` | `diff` | `cp`

1. **Инициализация репозитория**:

```bash
mkdir gitops-lab && cd gitops-lab
git init
```

2. **Создание желаемого состояния**:

```bash
echo "version: 1.0" > desired-state.txt
git add . && git commit -m "Начальное состояние"
```

3. **Симулировать работающий кластер**:

```bash
cp desired-state.txt current-state.txt
```

4. **Создать скрипт согласования**:

```bash
#!/bin/bash
# reconcile.sh
DESIRED=$(cat desired-state.txt)
CURRENT=$(cat current-state.txt)

if [ "$DESIRED" != "$CURRENT" ]; then
echo "$(date) - ОБНАРУЖЕН ДРЕЙФ! Согласование..."
cp desired-state.txt current-state.txt
fi
```

5. **Запустить ручной дрейф**:

```bash
echo "version: 2.0" > current-state.txt # Имитировать ручное изменение кластера
```

6. **Запустить согласование**:

```bash
chmod +x reconcile.sh
./reconcile.sh # Следует обнаружить и исправить дрейф
```

7. **Автоматизировать согласование**:

```bash
watch -n 5 ./reconcile.sh # Запускается каждые 5 секунд
```

8. **Документация**:
- Создать файл `submission7.md`.
- Предоставить вывод.

### Ожидаемый результат

```bash
Пн 3 июл 14:30:00 UTC 2023 - ОБНАРУЖЕН ДРЕЙФ! Согласование...
```

---

## **Задача 2: Мониторинг работоспособности GitOps**

**Цель**: Реализовать проверки работоспособности для синхронизации конфигурации

Почему это важно:

- Научиться проверять согласованность состояния системы
- Обнаруживать дрейф конфигурации до того, как он приведет к сбоям
- Создавайте упреждающий мониторинг для систем GitOps

Используемые инструменты:

`md5sum` | `cron` | `echo` | `date`

1. **Создать скрипт проверки работоспособности**:

```bash
#!/bin/bash
# healthcheck.sh
DESIRED_MD5=$(md5sum desired-state.txt | awk '{print $1}')
CURRENT_MD5=$(md5sum current-state.txt | awk '{print $1}')

if [ "$DESIRED_MD5" != "$CURRENT_MD5" ]; then
echo "$(date) - CRITICAL: State mismatch!" >> health.log
else
echo "$(date) - OK: состояния синхронизированы" >> health.log
fi
```

2. **Создать исполняемый файл**:

```bash
chmod +x healthcheck.sh
```

3. **Смоделировать работоспособное состояние**:

```bash
./healthcheck.sh
cat health.log# Должно быть показано "OK"
```

4. **Создать дрейф**:

```bash
echo "unapproved change" >> current-state.txt
```

5. **Запустить проверку работоспособности**:

```bash
./healthcheck.sh
cat health.log# Теперь отображается "CRITICAL"
```

6. **Документация**:
- Предоставьте вывод в файле `submission7.md`.

### Ожидаемый вывод в `health.log`

```bash
Пн июл 3 14:35:00 UTC 2023 - ОК: состояния синхронизированы
Пн июл 3 14:36:00 UTC 2023 - КРИТИЧЕСКИЙ: несоответствие состояний!
```

---

### **Руководство по лабораторной работе**

- Используйте правильное форматирование и структуру Markdown для файлов документации.
- Организуйте файлы в папке лабораторной работы, используя соответствующие соглашения об именовании.
- Создайте запрос на извлечение в основную ветку репозитория с выполненным лабораторным заданием.

1. **Продемонстрированные основные концепции**:

| Задача | Принцип GitOps | Реальный эквивалент |
|------|-------------------|------------------------|
| 1 | Непрерывное согласование | Циклы синхронизации Argo CD/Flux |
| 2 | Мониторинг работоспособности | Проверки статуса оператора Kubernetes |
